<script lang="ts">
	import { useThrelte, watch } from '@threlte/core'
	import { onMount } from 'svelte'
	import { Object3D } from 'three'
	import { SelectionBox } from 'three/examples/jsm/interactive/SelectionBox.js'
	import { SelectionHelper } from 'three/examples/jsm/interactive/SelectionHelper.js'
	import { useStudio } from '../../internal/extensions'
	import { useStudioObjectsRegistry } from '../studio-objects-registry/useStudioObjectsRegistry.svelte'
	import {
		objectSelectionScope,
		type ObjectSelectionActions,
		type ObjectSelectionState,
	} from './types'
	import { useObjectSelection } from './useObjectSelection.svelte'

	const { camera, scene, renderer } = useThrelte()

	const { getExtension } = useStudio()
	const { addToSelection, removeFromSelection, selectObjects } = useObjectSelection()
	const { run } = getExtension<ObjectSelectionState, ObjectSelectionActions>(objectSelectionScope)

	const selectionBox = new SelectionBox(camera.current, scene)
	const helper = new SelectionHelper(renderer, 'selectBox')

	const studioObjectsRegistry = useStudioObjectsRegistry()

	watch(camera, (camera) => {
		selectionBox.camera = camera
	})

	const filter = (objects: Object3D[]): Object3D[] => {
		let objs = objects.filter((object) => {
			return !studioObjectsRegistry.objects.has(object)
		})
		return objs
	}

	let selectionMode: 'select' | 'remove' | 'add' = 'select'
	let lastEvent: MouseEvent

	const onPointerDown = (event: MouseEvent) => {
		if (event.shiftKey) {
			event.preventDefault()
			selectionMode = 'add'
		} else if (event.ctrlKey || event.metaKey) {
			event.preventDefault()
			selectionMode = 'remove'
		} else {
			selectionMode = 'select'
		}
		selectionBox.startPoint.set(
			(event.clientX / window.innerWidth) * 2 - 1,
			-(event.clientY / window.innerHeight) * 2 + 1,
			0.5,
		)
		run('setInUse', true)
		lastEvent = event
	}

	const onPointerMove = (event: MouseEvent) => {
		if (!helper.isDown) return
		selectionBox.endPoint.set(
			(event.clientX / window.innerWidth) * 2 - 1,
			-(event.clientY / window.innerHeight) * 2 + 1,
			0.5,
		)
		const allSelected = filter(selectionBox.select())
		if (selectionMode === 'add') {
			addToSelection(allSelected)
		} else if (selectionMode === 'remove') {
			removeFromSelection(allSelected)
		} else {
			selectObjects(allSelected)
		}
		lastEvent = event
	}

	const onPointerUp = (event: MouseEvent) => {
		if (!helper.isDown) return
		selectionBox.endPoint.set(
			(event.clientX / window.innerWidth) * 2 - 1,
			-(event.clientY / window.innerHeight) * 2 + 1,
			0.5,
		)

		const allSelected = filter(selectionBox.select())
		if (selectionMode === 'add') {
			addToSelection(allSelected)
		} else if (selectionMode === 'remove') {
			removeFromSelection(allSelected)
		} else {
			selectObjects(allSelected)
		}
		run('setInUse', false)
	}

	onMount(() => {
		renderer.domElement.addEventListener('pointerdown', onPointerDown)
		renderer.domElement.addEventListener('pointermove', onPointerMove)
		renderer.domElement.addEventListener('pointerup', onPointerUp)
		return () => {
			if (lastEvent) onPointerUp(lastEvent)
			renderer.domElement.removeEventListener('pointerdown', onPointerDown)
			renderer.domElement.removeEventListener('pointermove', onPointerMove)
			renderer.domElement.removeEventListener('pointerup', onPointerUp)
			try {
				// this sometimes throws an error, but we fail silently
				const h = helper as any
				if (h.element && h.element.parentElement) h.onSelectOver()
			} catch (error) {
				console.warn(error)
			}
			helper.dispose()
		}
	})
</script>

<style>
	:global(.selectBox) {
		border: 1px solid #3662e3;
		background-color: #3661e339;
		position: fixed;
	}
</style>
